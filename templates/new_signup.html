<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - MINI</title>

    <!-- Import Google font similar to Helvetica Neue -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <link rel="shortcut icon" href="{{ url_for('static', filename='images/ico.svg') }}" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mulish:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/ico.svg') }}" type="image/x-icon">
    <!DOCTYPE html>
    <html lang="es">
        <head>
            <meta charset="UTF-8">
            <title>Registro con Solana</title>
            <!-- Asegúrate de servir tu sitio sobre HTTPS -->
            <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@latest/lib/index.iife.min.js"></script>
            <!-- Incluye buffer-layout si es necesario -->
            <script src="https://cdn.jsdelivr.net/npm/buffer-layout@1.2.0/lib/index.js"></script>
       <!-- Importar fuentes de Google similares a Helvetica Neue -->
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Mulish:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    
        <link rel="shortcut icon" href="{{ url_for('static', filename='images/ico.svg') }}" type="image/x-icon">
        <style>
            /* General body styling */
            * {
                font-family: 'Mulish', 'Roboto', Arial, sans-serif;
                box-sizing: border-box;
                font-size: 19px;
            }
    
            body {
                margin: 0;
                padding: 0;
                background-color: #000;
                color: white;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                box-sizing: border-box;
            }
    
            /* Container for the whole layout */
            .container {
                margin-top: 50px;
                display: flex;
                width: 85%;
                box-shadow: 0px 8px 24px rgba(0, 0, 0, 0.8);
                border-radius: 10px;
            }
    
            /* Left section (Sign Up form) */
            .sesion_signup {
                background-color: #0e0e0e;
                width: 50%;
                padding: 40px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                box-sizing: border-box;
                text-align: center;
            }
    
            h1, p, h2 {
                color: white;
            }
    
            h1 {
                font-size: 24px;
                margin-bottom: 15px;
                text-align: center;
            }
    
            p {
                font-size: 19px;
                line-height: 1.5;
                margin-bottom: 30px;
                text-align: center;
            }
    
            h2 {
                font-size: 22px;
                margin-bottom: 15px;
            }
    
            .input-group {
                margin-bottom: 20px;
                text-align: left;
            }
    
            .input-group label {
                font-size: 19px;
                margin-bottom: 5px;
                display: block;
                color: #aaa;
            }
    
            .input-group input {
                width: 100%;
                padding: 10px;
                background-color: #333;
                border: none;
                border-radius: 5px;
                color: white;
                box-sizing: border-box;
            }
    
            /* Button styling */
            button, .copy-button {
                width: 100%;
                padding: 10px;
                background-color: #3f8e9c;
                border: none;
                color: white;
                font-size: 16px;
                border-radius: 5px;
                cursor: pointer;
                margin-bottom: 10px;
                transition: background-color 0.3s ease;
            }
    
            button:hover, .copy-button:hover {
                background-color: #155ab6;
            }
    
            /* Google Sign-in button */
            .google-signin {
                background-color: white;
                color: #000;
                font-size: 14px;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 10px;
                border-radius: 5px;
                cursor: pointer;
                margin-bottom: 20px;
                transition: background-color 0.3s ease, color 0.3s ease;
            }
    
            .google-signin:hover {
                background-color: #f1f1f1;
            }
    
            .google-signin img {
                width: 18px;
                height: 18px;
                margin-right: 8px;
            }
    
            /* Additional Links */
            .additional-links {
                display: flex;
                justify-content: space-between;
                margin-top: 10px;
            }
    
            .additional-links a {
                color: #3f8e9c;
                text-decoration: none;
                font-size: 19px;
                transition: text-decoration 0.3s ease;
            }
    
            .additional-links a:hover {
                text-decoration: underline;
            }
    
            /* Right section (Image section) */
            .image-section {
                width: 50%;
                background: url("{{ url_for('static', filename='images/ia_image.jpg', cache_timeout=0) }}") no-repeat center center/cover;
                display: flex;
                justify-content: center;
                align-items: center;
                position: relative;
                box-sizing: border-box;
            }
    
            .image-section .overlay-text {
                font-size: 100px;
                font-weight: bold;
                color: white;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            }
    
            /* Scrollbar styling */
            ::-webkit-scrollbar {
                width: 10px;
            }
    
            ::-webkit-scrollbar-track {
                background: #333; /* Fondo de la pista de la scrollbar */
            }
    
            ::-webkit-scrollbar-thumb {
                background: linear-gradient(180deg, #3a8592, #155ab6); /* Gradiente en el "thumb" */
                border-radius: 5px;
            }
    
            ::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(180deg, #155ab6, #3f8e9c); /* Gradiente al pasar el mouse */
            }
    
            /* Media Queries for Responsive Design */
    
            /* Tablets and smaller devices */
            @media (max-width: 768px) {
                .container {
                    margin-top: 50px;
                    flex-direction: column;
                    width: 90%;
                }
    
                .sesion_signup, .image-section {
                    width: 100%;
                }
    
                .sesion_signup {
                    padding: 20px;
                }
    
                .image-section {
                    display: none;
                }
    
                .image-section .overlay-text {
                    font-size: 50px;
                }
    
                h1, h2 {
                    font-size: 20px;
                }
    
                p {
                    font-size: 17px;
                }
    
                .input-group label, .input-group input, button, .google-signin, .additional-links a {
                    font-size: 16px;
                }
            }
    
            /* Mobile devices */
            @media (max-width: 480px) {
                body {
                    height: auto;
                    padding: 20px 0;
                }
    
                .container {
                    box-shadow: none;
                    border-radius: 0;
                    width: 100%;
                }
    
                .image-section .overlay-text {
                    font-size: 30px;
                }
    
                h1, h2 {
                    font-size: 18px;
                }
    
                p {
                    font-size: 15px;
                }
    
                .input-group label, .input-group input, button, .google-signin, .additional-links a {
                    font-size: 14px;
                }
    
                .google-signin img {
                    width: 16px;
                    height: 16px;
                }
            }
    
            /* Landscape phones */
            @media (max-width: 600px) and (orientation: landscape) {
                .image-section .overlay-text {
                    font-size: 40px;
                }
    
                h1 {
                    font-size: 19px;
                }
    
                p {
                    font-size: 16px;
                }
            }
    
            /* High-resolution devices */
            @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
                .image-section .overlay-text {
                    text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <!-- Left Section: Sign Up Form -->
            <div class="sesion_signup">
                <a href="/"> 
                    <img src="{{ url_for('static', filename='images/ico.svg', cache_timeout=0) }}" style="width: 100px;" alt="Logo">
                </a>
                <h1>Register Your Account</h1>
                <p>MINI is a memecoin created by Dalas Review, inspired by his popular YouTube character MINI. Built on the Solana Network, it features integrated AI to enhance user experience and optimize transactions. MINI combines meme culture with advanced technology, creating a fun and engaging crypto community.</p>
                
                <!-- Formulario de Registro con Username y Password -->
                <form id="registration-form">
                    <div class="input-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" placeholder="Enter your username" required>
                    </div>
                    <div class="input-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" placeholder="Enter your password" required>
                    </div>
    
                    <!-- Step 1: Connect Wallet -->
                    <div class="register-face-1 sesion_login">
                        <h2>Step 1: Connect Your Solana Wallet</h2>
                        <div class="button-group">
                            <button type="button" id="connect-wallet-button">Connect Wallet</button>
                        </div>
                    </div>
    
                    <!-- Step 2: Confirm Transaction -->
                    <div class="register-face-2 sesion_login" style="display: none;">
                        <h2>Step 2: Confirm Transaction</h2>
                        <p>Please approve the transaction in your wallet to complete the registration.</p>
                    </div>
    
                    <!-- Botón de Registro -->
                    <button type="submit" id="register-button">Register</button>
                </form>
    
                <!-- Google Sign-in button -->
                <button class="google-signin">
                    <img src="https://p1.hiclipart.com/preview/209/923/667/google-logo-background-g-suite-google-pay-google-doodle-text-circle-line-area-png-clipart.jpg" alt="Google logo">
                    Sign up with Google
                </button>
    
                <div class="additional-links">
                    <a href="/login">Already have an account? Login</a>
                    <a href="/deposit_tokens">Deposit more balance</a>
                </div>
            </div>
    
            <!-- Right Section: Image and Overlay Text -->
            <div class="image-section">
                <!-- Contenido adicional si es necesario -->
            </div>
        </div>
    
        <!-- Librerías de Solana -->
        <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@latest/lib/index.iife.min.js"></script>
        
        <script>
            (function() { 
                // Check if solanaWeb3 is loaded
                console.log('solanaWeb3:', solanaWeb3); 
                if (!solanaWeb3) {
                    alert('Error: The solanaWeb3 library was not loaded correctly.');
                    throw new Error('solanaWeb3 not loaded');
                }
        
                // Check if splToken is loaded
                console.log('splToken:', splToken); 
                if (!splToken) {
                    alert('Error: The splToken library was not loaded correctly.');
                    throw new Error('splToken not loaded');
                }
        
                // Correct program IDs
                const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");
                const ASSOCIATED_TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL");
        
                // Mint and target wallet addresses
                const TOKEN_MINT_ADDRESS = '9nmu7zbf1kKNb52cAohAzyjD3yRdG8Pszw15Umsupump'; // Replace with your actual mint address
                const TARGET_WALLET_ADDRESS = 'BvFpU5BJnZymBzdQHX91SGVJTMaAm89z6Jr9Z4TaopBG'; // Replace with target wallet address
        
                // Initialize PublicKey objects
                const tokenMintPubkey = new solanaWeb3.PublicKey(TOKEN_MINT_ADDRESS);
                const targetWalletPubkey = new solanaWeb3.PublicKey(TARGET_WALLET_ADDRESS);
        
                // Global variables for connection and provider
                let provider;
                let connection;
                let publicKey;
        
                // Specify your own RPC URL here
                // Recommendation: Use a standard RPC or ensure your custom RPC has CORS configured correctly
                const RPC_URL = '{{endpoint_solana}}';
        
                // DOM element references
                const connectWalletButton = document.getElementById('connect-wallet-button');
                const registerForm = document.getElementById('registration-form');
        
                // Polling function to confirm the transaction with timeout
                async function waitForConfirmation(connection, signature, timeout = 600000, interval = 5000) { // Timeout set to 10 minutes (600,000 ms)
                    const startTime = Date.now();
        
                    return new Promise((resolve, reject) => {
                        const timer = setInterval(async () => {
                            try {
                                const status = await connection.getSignatureStatus(signature);
                                const confirmation = status && status.value && 
                                    (status.value.confirmationStatus === 'confirmed' || status.value.confirmationStatus === 'finalized');
        
                                if (confirmation) {
                                    clearInterval(timer);
                                    resolve(status.value);
                                } else if (Date.now() - startTime > timeout) {
                                    clearInterval(timer);
                                    reject(new Error('Transaction confirmation timeout.'));
                                }
                            } catch (error) {
                                clearInterval(timer);
                                reject(error);
                            }
                        }, interval);
                    });
                }
        
                // Custom implementation of getAssociatedTokenAddress
                async function getAssociatedTokenAddress(mint, owner) {
                    return (await solanaWeb3.PublicKey.findProgramAddress(
                        [
                            owner.toBuffer(),
                            TOKEN_PROGRAM_ID.toBuffer(),
                            mint.toBuffer(),
                        ],
                        ASSOCIATED_TOKEN_PROGRAM_ID
                    ))[0];
                }
        
                // Custom implementation of createAssociatedTokenAccountInstruction
                function createAssociatedTokenAccountInstruction(payer, ata, owner, mint) {
                    const keys = [
                        { pubkey: payer, isSigner: true, isWritable: true },
                        { pubkey: ata, isSigner: false, isWritable: true },
                        { pubkey: owner, isSigner: false, isWritable: false },
                        { pubkey: mint, isSigner: false, isWritable: false },
                        { pubkey: solanaWeb3.SystemProgram.programId, isSigner: false, isWritable: false },
                        { pubkey: solanaWeb3.SYSVAR_RENT_PUBKEY, isSigner: false, isWritable: false },
                        { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
                    ];
                    return new solanaWeb3.TransactionInstruction({
                        keys,
                        programId: ASSOCIATED_TOKEN_PROGRAM_ID,
                        data: new Uint8Array(0), // Empty data
                    });
                }
        
                // Custom implementation of createTransferCheckedInstruction
                function createTransferCheckedInstruction(source, mint, destination, owner, amount, decimals) {
                    const data = new Uint8Array(10);
                    const dataView = new DataView(data.buffer);
        
                    dataView.setUint8(0, 12); // Instruction index for TransferChecked
                    // Set the amount in little-endian
                    const amountBigInt = BigInt(amount);
                    dataView.setBigUint64(1, amountBigInt, true); // From byte 1 to 8
                    dataView.setUint8(9, decimals); // Token decimals
        
                    const keys = [
                        { pubkey: source, isSigner: false, isWritable: true },
                        { pubkey: mint, isSigner: false, isWritable: false },
                        { pubkey: destination, isSigner: false, isWritable: true },
                        { pubkey: owner, isSigner: true, isWritable: false },
                    ];
        
                    return new solanaWeb3.TransactionInstruction({
                        keys,
                        programId: TOKEN_PROGRAM_ID,
                        data: data,
                    });
                }
        
                // Handle "Connect Wallet" click
                connectWalletButton.addEventListener('click', async (event) => {
                    event.preventDefault();
        
                    // Check for a Solana wallet
                    if (window.solana && window.solana.isPhantom) {
                        provider = window.solana;
                    } else if (window.solflare && window.solflare.isSolflare) {
                        provider = window.solflare;
                    } else {
                        alert('Please install Phantom or Solflare wallet extension.');
                        return;
                    }
        
                    try {
                        // Connect to the wallet
                        const resp = await provider.connect();
        
                        // Get the public key
                        if (resp && resp.publicKey) {
                            publicKey = resp.publicKey.toString();
                        } else if (provider.publicKey) {
                            publicKey = provider.publicKey.toString();
                        } else {
                            throw new Error('Unable to get the public key after connecting.');
                        }
        
                        console.log('Connected to wallet:', publicKey);
        
                        // Proceed to the next step
                        document.querySelector('.register-face-1').style.display = 'none';
                        document.querySelector('.register-face-2').style.display = 'block';
                    } catch (err) {
                        console.error(err);
                        alert('Error connecting to wallet: ' + err.message);
                    }
                });
        
                // Handle registration form submission
                registerForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
        
                    // Ensure wallet is connected
                    if (!publicKey) {
                        alert('Please connect your wallet before registering.');
                        return;
                    }
        
                    // Get input field values
                    const username = document.getElementById('username').value.trim();
                    const password = document.getElementById('password').value.trim();
        
                    // Validate fields are not empty
                    if (!username || !password) {
                        alert('Please fill out all fields.');
                        return;
                    }
        
                    // Create connection to Solana using specified RPC URL
                    connection = new solanaWeb3.Connection(RPC_URL, 'confirmed');
                    console.log('Connection established:', connection);
        
                    try {
                        // Get specific amount from the backend
                        const response = await fetch('/get_specific_amount_for_authentication', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ wallet: publicKey })
                        });
        
                        const data = await response.json();
        
                        if (response.ok) {
                            if (data.success) {
                                const amount = data.amount; // Amount to send (as a string, e.g., "0.5")
                                const hashTrackingSignup = data.hash_tracking_signup;
        
                                // Save hashTrackingSignup in a cookie for later use
                                const expires = new Date(Date.now() + 5 * 60 * 1000).toUTCString();
                                document.cookie = `pending_verify_hash=${hashTrackingSignup}; expires=${expires}; path=/; Secure; SameSite=Strict`;
        
                                // Initiate the transaction
                                await sendTokenTransaction(amount, username, password);
                            } else {
                                alert(data.error || "Error getting the amount.");
                            }
                        } else {
                            alert(data.error || "Error getting the amount.");
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Error getting the amount: ' + err.message);
                    }
                });
        
                async function sendTokenTransaction(amount, username, password) {
                    try {
                        if (!connection) {
                            throw new Error('Connection to Solana not established.');
                        }
        
                        // Parse the amount to the correct decimal (6 decimals)
                        const tokenAmount = Math.round(parseFloat(amount) * 1e6); // Convert to integer
        
                        // Create transaction
                        const transaction = new solanaWeb3.Transaction();
        
                        // Get public keys
                        const userPublicKey = new solanaWeb3.PublicKey(publicKey);
                        const targetPublicKey = new solanaWeb3.PublicKey(TARGET_WALLET_ADDRESS);
        
                        // Get Associated Token Accounts (ATA) using custom function
                        const userATA = await getAssociatedTokenAddress(tokenMintPubkey, userPublicKey);
                        const targetATA = await getAssociatedTokenAddress(tokenMintPubkey, targetPublicKey);
        
                        // Check if user's ATA exists and has sufficient balance
                        const userATAInfo = await connection.getAccountInfo(userATA);
                        let sourceTokenAccount = null;
        
                        if (userATAInfo !== null) {
                            const tokenAccountBalanceResponse = await connection.getTokenAccountBalance(userATA);
                            const tokenAccountBalance = parseInt(tokenAccountBalanceResponse.value.amount);
        
                            if (tokenAccountBalance >= tokenAmount) {
                                sourceTokenAccount = userATA;
                            }
                        }
        
                        // If sufficient balance was not found in ATA, search other accounts
                        if (!sourceTokenAccount) {
                            // Get all user's token accounts for the specific mint
                            const tokenAccounts = await connection.getParsedTokenAccountsByOwner(userPublicKey, {
                                mint: tokenMintPubkey
                            });
        
                            // Sum balances and find an account with sufficient balance
                            for (let accountInfo of tokenAccounts.value) {
                                const balance = parseInt(accountInfo.account.data.parsed.info.tokenAmount.amount);
                                if (balance >= tokenAmount) {
                                    sourceTokenAccount = new solanaWeb3.PublicKey(accountInfo.pubkey);
                                    break;
                                }
                            }
                        }
        
                        if (!sourceTokenAccount) {
                            alert("You don't have enough tokens to send. You need to have at least 5 USD equivalent in MINI tokens in your wallet");
                            window.open('https://raydium.io/swap/?inputMint=9nmu7zbf1kKNb52cAohAzyjD3yRdG8Pszw15Umsupump&outputMint=sol', '_blank');
                            return;
                        }
        
                        // Check if target's ATA exists
                        const targetATAInfo = await connection.getAccountInfo(targetATA);
                        if (targetATAInfo === null) {
                            const createATAIx = createAssociatedTokenAccountInstruction(
                                userPublicKey, // Payer
                                targetATA,      // ATA to create
                                targetPublicKey,// Owner
                                tokenMintPubkey // Mint
                            );
                            transaction.add(createATAIx);
                        }
        
                        // Create transfer instruction using custom function
                        const transferIx = createTransferCheckedInstruction(
                            sourceTokenAccount,
                            tokenMintPubkey,
                            targetATA,
                            userPublicKey,
                            tokenAmount,
                            6 // Decimals
                        );
        
                        transaction.add(transferIx);
        
                        // Set recentBlockhash and fee payer
                        transaction.feePayer = userPublicKey;
                        const latestBlockhash = await connection.getLatestBlockhash();
                        transaction.recentBlockhash = latestBlockhash.blockhash;
        
                        // Sign and send the transaction
                        const signedTransaction = await provider.signTransaction(transaction);
                        const signature = await connection.sendRawTransaction(signedTransaction.serialize());
        
                        console.log('Transaction signature:', signature);
        
                        // Wait for transaction confirmation with a timeout of 10 minutes
                        try {
                            await waitForConfirmation(connection, signature, 600000, 5000); // 600,000 ms = 10 minutes
                            alert('Transaction successful! Transaction signature: ' + signature);
                        } catch (confirmationError) {
                            console.error('Transaction confirmation error:', confirmationError);
                            alert('Transaction is pending or failed. Please check the signature on Solana Explorer: ' + signature);
                            return;
                        }
        
                        // Proceed to confirm and sign up with username and password
                        await confirmAndSignup(signature, username, password);
                    } catch (error) {
                        console.error('Transaction failed:', error);
                        alert('Transaction failed: ' + error.message);
                    }
                }
        
                async function confirmAndSignup(signature, username, password) {
                    // Get the pending verification hash from the cookie
                    const pendingVerifyHash = getCookie('pending_verify_hash');
        
                    try {
                        const response = await fetch('/confirm_and_signup', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                wallet: publicKey,
                                signature: signature,
                                username: username,
                                password: password,
                                hash_pending_verify: pendingVerifyHash
                            })
                        });
        
                        const data = await response.json();
        
                        if (response.ok) {
                            if (data.success) {
                                document.cookie = `session_cookie=${data.sessionHash}; path=/; max-age=432000; Secure; SameSite=Strict`;
                                window.location.href = '/login';
                            } else {
                                alert(data.error);
                            }
                        } else {
                            alert(data.error || "Registration failed.");
                        }
                    } catch (error) {
                        alert("An error occurred while attempting to register: " + error.message);
                    }
                }
        
                // Function to get the value of a cookie by name
                function getCookie(name) {
                    let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
                    if (match) return match[2];
                    return null;
                }
        
            })();
        </script>
            </body>
</html>
